name: Build and Release Executable for Windows

permissions:
  contents: write

on:
  push:
    tags:
      - 'v*' # run on every version tag pushed

jobs:
  build:
    runs-on: windows-2022

    steps:
    # Checkout the repository
    - name: Checkout repository
      uses: actions/checkout@v3

    # Install Qt for Windows with MinGW
    - name: Set up Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.8.1'
        host: 'windows'
        target: 'desktop'
        arch: 'win64_mingw'
        tools: 'tools_mingw1120 qt.tools.mingw1120'

    # Build via CMake with MinGW
    - name: Build application
      run: |
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -G "MinGW Makefiles"
        cmake --build build --config Release

    # Run windeployqt on the built executable
    - name: Run windeployqt
      run: |
        $exe = "build\appcob_zippy_ai.exe"
        & "$Env:Qt_ROOT_DIR\bin\windeployqt.exe" --release $exe

    # Zip the entire build/ folder (with Qt DLLs)
    - name: Package build directory
      run: |
        powershell Compress-Archive -Path build\* -DestinationPath build.zip -Force

    # Upload ZIP to GitHub Release
    - name: Upload ZIP to GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: build.zip
